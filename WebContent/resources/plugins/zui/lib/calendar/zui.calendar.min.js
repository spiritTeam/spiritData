/*!
 * ZUI - v1.2.1 - 2015-01-14
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2015 cnezsoft.com; Licensed MIT
 */

!function(a,b){"use strict";var c="zui.calendar",d=function(a,b){b=b||1;for(var c=a.clone();c.getDay()!=b;)c.addDays(-1);return c.setHours(0),c.setMinutes(0),c.setSeconds(0),c.setMilliseconds(0),c},e=function(a){var b=a.clone();return b.setDate(1),b},f=function(d,e){if(this.name=c,this.$=a(d),this.id=this.$.attr("id")||c+a.uuid(),this.$.attr("id",this.id),this.storeName=c+"."+this.id,this.getOptions(e),this.getLang(),this.data=this.options.data,this.calendars=a.isPlainObject(this.data.calendars)?this.data.calendars:{},this.events=this.data.events,this.sortEvents(),this.storeData=b.store.pageGet(this.storeName,{date:"today",view:"month"}),this.date=this.options.startDate||(this.options.storage?this.storeData.date:"today"),this.view=this.options.startView||(this.options.storage?this.storeData.view:"month"),this.$.toggleClass("limit-event-title",e.limitEventTitle),this.options.withHeader){var f=this.$.children(".calender-header");f.length||(f=a('<header><div class="btn-toolbar"><div class="btn-group"><button type="button" class="btn btn-today">{today}</button></div><div class="btn-group"><button type="button" class="btn btn-prev"><i class="icon-chevron-left"></i></button><button type="button" class="btn btn-next"><i class="icon-chevron-right"></i></button></div><div class="btn-group"><span class="calendar-caption"></span></div></div></header>'.format(this.lang)),this.$.append(f)),this.$caption=f.find(".calendar-caption"),this.$todayBtn=f.find(".btn-today"),this.$header=f}var g=this.$.children(".calendar-views");g.length||(g=a('<div class="calendar-views"></div>'),this.$.append(g)),this.$views=g,this.$monthView=g.children(".calendar-view.month"),this.display(),this.bindEvents()};f.DEFAULTS={langs:{zh_cn:{weekNames:["周一","周二","周三","周四","周五","周六","周日"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],today:"今天",year:"{0}年",month:"{0}月",yearMonth:"{0}年{1}月"}},data:{calendars:{defaultCal:{color:"#229F24"}},events:[]},limitEventTitle:!0,storage:!0,withHeader:!0,dragThenDrop:!0},f.prototype.sortEvents=function(){var b=this.events;a.isArray(b)||(b=[]),a.each(b,function(b,c){"string"==typeof c.start&&(c.start=new Date(c.start)),"string"==typeof c.end&&(c.end=new Date(c.end)),"undefined"==typeof c.id&&(c.id=a.uuid())}),b.sort(function(a,b){return a.start>b.start?1:a.start<b.start?-1:0})},f.prototype.bindEvents=function(){var b=this.$,c=this;b.on("click",".btn-today",function(){c.date=new Date,c.display(),c.callEvent("clickTodayBtn")}).on("click",".btn-next",function(){"month"===c.view&&c.date.addMonths(1),c.display(),c.callEvent("clickNextBtn")}).on("click",".btn-prev",function(){"month"===c.view&&c.date.addMonths(-1),c.display(),c.callEvent("clickPrevBtn")}).on("click",".event",function(b){c.callEvent("clickEvent",{event:a(this).data("event"),events:c.events}),b.stopPropagation()}).on("click",".cell-day",function(){c.callEvent("clickCell",{view:c.view,date:a(this).attr("data-date"),events:c.events})})},f.prototype.addCalendars=function(b){var c=this;a.isPlainObject(b)&&(b=[b]),a.each(b,function(a,b){c.callEvent("beforeAddCalendars",{newCalendar:b,data:c.data})&&c.calendars[b.name](b)}),c.display(),c.callEvent("addCalendars",{newCalendars:b,data:c.data})},f.prototype.addEvents=function(b){var c=this;a.isPlainObject(b)&&(b=[b]),a.each(b,function(a,b){c.callEvent("beforeAddEvent",{newEvent:b,data:c.data})&&c.events.push(b)}),c.sortEvents(),c.display(),c.callEvent("addEvents",{newEvents:b,data:c.data})},f.prototype.getEvent=function(a){for(var b=this.events,c=0;c<b.length;c++)if(b[c].id==a)return b[c];return null},f.prototype.updateEvents=function(b){var c={data:this.data,changes:[]},d=this;a.isPlainObject(b)&&(b=[b]);var e,f,g;a.each(b,function(b,h){e=h.event,f=h.changes,g={event:e,changes:[]},"string"==typeof e&&(e=d.getEvent(e)),e&&(a.isPlainObject(f)&&(f=[f]),a.each(function(b,c){d.callEvent("beforeChange",{event:e,change:c.change,to:c.to,from:e[c.change]})&&(g.changes.push(a.entend(!0,{},c,{from:e[c.change]})),e[c.change]=c.to)})),c.changes.push(g)}),d.sortEvents(),d.display(),d.callEvent("change",c)},f.prototype.removeEvents=function(b){a.isArray(b)||(b=[b]);var c,d,e,f=this.events,g=this,h=[];a.each(b,function(b,i){c=a.isPlainObject(i)?i.id:i,e=-1;for(var j=0;j<f.length;j++)if(f[j].id==c){e=j,d=f[j];break}e>=0&&g.callEvent("beforeRemoveEvent",{event:d,eventId:c,data:g.data})&&(f.splice(e,1),h.push(d))}),g.sortEvents(),g.display(),g.callEvent("removeEvents",{removedEvents:h,data:g.data})},f.prototype.getOptions=function(b){this.options=a.extend({},f.DEFAULTS,this.$.data(),b)},f.prototype.getLang=function(){this.lang=this.options.langs[this.options.lang||a.clientLang()]},f.prototype.display=function(a,c){var d=this;"undefined"==typeof a?a=d.view:d.view=a,"undefined"==typeof c?c=d.date:d.date=c,"today"===c?(c=new Date,d.date=c):"string"==typeof c&&(c=new Date(c),d.date=c),d.options.storage&&b.store.pageSet(d.storeName,{date:c,view:a});var e={view:a,date:c};if(d.callEvent("beforeDisplay",e)){switch(a){case"month":d.displayMonth(c)}d.callEvent("display",e)}},f.prototype.displayMonth=function(){var b,c=this,f=c.options,g=c,h=c.lang,i=c.date,j=c.$views,k=c.$,l=g.$monthView;if(!l.length){l=a('<div class="calendar-view month"><table class="table table-bordered"><thead><tr class="week-head"></tr></thead><tbody class="month-days"></tbody></table></div>');var m,n=l.find(".week-head"),o=l.find(".month-days");for(b=0;7>b;b++)n.append("<th>"+h.weekNames[b]+"</th>");for(b=0;6>b;b++){m=a('<tr class="week-days"></tr>');for(var p=0;7>p;p++)m.append('<td class="cell-day"><div class="day"><div class="heading"><span class="month"></span> <span class="number"></span></div><div class="content"><div class="events"></div></div></div></td>');o.append(m)}j.append(l),g.$monthView=l}var q,r,s,t,u,v,w=l.find(".week-days"),x=l.find(".day"),y=e(i),z=new Date,A=d(y),B=i.getFullYear(),C=i.getMonth(),D=z.getMonth(),E=z.getFullYear(),F=z.getDate(),G=A.clone().addDays(42).addMilliseconds(-1),H=A.clone().addDays(1).addMilliseconds(-1);w.each(function(b){q=a(this),q.find(".day").each(function(c){r=a(this),s=r.closest(".cell-day"),t=H.getFullYear(),u=H.getDate(),v=H.getMonth(),r.attr("data-date",H.toDateString()),r.find(".heading > .number").text(u),r.find(".heading > .month").toggle(0===b&&0===c||1===u).text((0===v&&1===u?h.year.format(t)+" ":"")+h.monthNames[v]),s.toggleClass("current-month",v===C),s.toggleClass("current",u===F&&v===D&&t===E),s.toggleClass("past",z>H),s.toggleClass("future",H>z),r.find(".events").empty(),H.addDays(1)})}),f.withHeader&&(c.$caption.text(h.yearMonth.format(B,C+1)),c.$todayBtn.toggleClass("disabled",C===D));var I,J,K=c.calendars;a.each(c.events,function(b,c){c.start>=A&&c.start<=G&&(r=x.filter('[data-date="'+c.start.toDateString()+'"]'),r.length&&(I=a('<div data-id="'+c.id+'" class="event" title="'+c.desc+'"><span class="time">'+c.start.format("hh:mm")+'</span> <span class="title">'+c.title+"</span></div>"),I.find(".time").toggle(!c.allDay),I.data("event",c),c.calendar&&(J=K[c.calendar],J&&I.data("calendar",J).css("background-color",J.color)),r.find(".events").append(I)))}),f.dragThenDrop&&l.find(".event").droppable({target:x,container:l,flex:!0,start:function(){k.addClass("event-dragging")},drop:function(a){var b=a.element.data("event"),c=a.target.attr("data-date"),d=b.start.clone();if(d.toDateString()!=c&&(c=new Date(c),c.setHours(d.getHours()),c.setMinutes(d.getMinutes()),c.setSeconds(d.getSeconds()),g.callEvent("beforeChange",{event:b,change:"start",to:c}))){var e=b.end.clone();b.end.addMilliseconds(b.end.getTime()-d.getTime()),b.start=c,a.target.find(".events").append(a.element),g.callEvent("change",{data:g.data,changes:[{event:b,changes:[{change:"start",from:d,to:b.start},{change:"end",from:e,to:b.end}]}]})}},finish:function(){k.removeClass("event-dragging")}})},f.prototype.callEvent=function(a,b){var c=this.$.callEvent(a+"."+this.name,b,this);return!(void 0!==c.result&&!c.result)},a.fn.calendar=function(b){return this.each(function(){var d=a(this),e=d.data(c),g="object"==typeof b&&b;e||d.data(c,e=new f(this,g)),"string"==typeof b&&e[b]()})},a.fn.calendar.Constructor=f}(jQuery,window);